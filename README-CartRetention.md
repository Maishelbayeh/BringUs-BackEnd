# نظام حفظ السلة للمستخدمين الضيوف 🛒

## 📋 نظرة عامة

نظام السلة يدعم نوعين من المستخدمين:
- **المستخدمون المسجلون** - سلة محفوظة بشكل دائم
- **المستخدمون الضيوف** - سلة محفوظة لمدة محدودة

## ⏰ مدة حفظ السلة

### للمستخدمين الضيوف:
- **المدة**: 30 يوم من آخر تحديث
- **الحذف**: تلقائي بواسطة MongoDB TTL index
- **التحديث**: كل مرة يتم فيها إضافة/تعديل/حذف عنصر

### للمستخدمين المسجلين:
- **المدة**: دائمة (لا تنتهي)
- **الحذف**: يدوي فقط

## 🔧 كيفية العمل

### 1. إنشاء guestId
```javascript
// عند أول طلب من مستخدم ضيف
const guestId = generateUUID(); // مثال: "550e8400-e29b-41d4-a716-446655440000"
```

### 2. حفظ السلة
```javascript
// في قاعدة البيانات
{
  _id: ObjectId("..."),
  user: null,                    // للمستخدمين الضيوف
  guestId: "550e8400-e29b-41d4-a716-446655440000",
  store: ObjectId("store_id"),
  items: [...],
  createdAt: ISODate("2024-01-01T10:00:00Z"),
  updatedAt: ISODate("2024-01-01T10:00:00Z")  // هذا الحقل يحدد وقت الحذف
}
```

### 3. TTL Index
```javascript
// حذف تلقائي بعد 30 يوم من آخر تحديث
cartSchema.index({ updatedAt: 1 }, { 
  expireAfterSeconds: 2592000, // 30 days
  partialFilterExpression: { guestId: { $exists: true, $ne: null } } 
});
```

## 📊 أمثلة عملية

### مثال 1: مستخدم ضيف يضيف منتج
```
التاريخ: 1 يناير 2024
الإجراء: إضافة منتج إلى السلة
النتيجة: updatedAt = 1 يناير 2024
الحذف: 31 يناير 2024 (تلقائي)
```

### مثال 2: مستخدم ضيف يحدث السلة
```
التاريخ: 15 يناير 2024
الإجراء: تحديث كمية منتج
النتيجة: updatedAt = 15 يناير 2024
الحذف: 14 فبراير 2024 (تلقائي)
```

### مثال 3: مستخدم ضيف يسجل دخول
```
التاريخ: 20 يناير 2024
الإجراء: تسجيل دخول
النتيجة: دمج السلة مع حساب المستخدم
الحذف: لا يتم حذفها (تصبح دائمة)
```

## 🛠️ تغيير مدة الحفظ

### لحفظ لمدة 7 أيام:
```javascript
cartSchema.index({ updatedAt: 1 }, { 
  expireAfterSeconds: 604800, // 7 days
  partialFilterExpression: { guestId: { $exists: true, $ne: null } } 
});
```

### لحفظ لمدة 24 ساعة:
```javascript
cartSchema.index({ updatedAt: 1 }, { 
  expireAfterSeconds: 86400, // 24 hours
  partialFilterExpression: { guestId: { $exists: true, $ne: null } } 
});
```

### لحفظ دائم (إلغاء TTL):
```javascript
// تعليق أو حذف السطر التالي
// cartSchema.index({ updatedAt: 1 }, { ... });
```

## 🔍 مراقبة السلات

### استعلام لرؤية السلات الحالية:
```javascript
// جميع السلات
db.carts.find()

// سلات الضيوف فقط
db.carts.find({ guestId: { $exists: true, $ne: null } })

// سلات المستخدمين المسجلين فقط
db.carts.find({ user: { $exists: true, $ne: null } })
```

### استعلام لرؤية السلات التي ستحذف قريباً:
```javascript
// السلات التي ستحذف خلال 7 أيام
db.carts.find({
  guestId: { $exists: true, $ne: null },
  updatedAt: { 
    $lt: new Date(Date.now() - 23 * 24 * 60 * 60 * 1000) 
  }
})
```

## ⚠️ ملاحظات مهمة

1. **TTL Index يعمل كل دقيقة** - لا يتم الحذف فوراً
2. **التحديث يطيل المدة** - أي إجراء على السلة يطيل مدة الحفظ
3. **الحذف نهائي** - لا يمكن استرجاع السلة المحذوفة
4. **المستخدمون المسجلون** - لا يتأثرون بـ TTL index

## 🎯 أفضل الممارسات

1. **إشعار المستخدمين** - تنبيه المستخدمين قبل انتهاء مدة السلة
2. **حفظ البيانات المهمة** - نسخ احتياطية للبيانات المهمة
3. **مراقبة الأداء** - مراقبة حجم قاعدة البيانات
4. **تحديث TTL** - تعديل المدة حسب احتياجات العمل

## 📞 الدعم

لأي استفسارات حول نظام حفظ السلة، يرجى التواصل مع فريق التطوير. 